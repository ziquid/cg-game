<?php
// $Id$

function celestial_glory_help($path, $arg) {

  $output = '';

  switch ($path) {

    case "admin/help#celestial_glory":
      $output = '<p>' . t('Back end for <em>Celestial Glory</em> game') . '</p>';
      break;

  }

  return $output;

} // celestial_glory_help()


function celestial_glory_perm() {

  return array('access celestial_glory content');

} // celestial_glory_perm()


function celestial_glory_menu() {

  $items['celestial_glory/home/%'] = array(
    'title' => 'Celestial Glory Home Page',
    'page callback' => 'celestial_glory_homepage_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
/*
  $items['celestial_glory/user/%'] = array(
    'title' => 'Celestial Glory User Profile Page',
    'page callback' => 'celestial_glory_userprofile_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
  
  $items['celestial_glory/quests/%'] = array(
    'title' => 'Celestial Glory Quests List',
    'page callback' => 'celestial_glory_quests_list_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );

  $items['celestial_glory/quests_do/%/%'] = array(
    'title' => 'Celestial Glory Quests Do',
    'page callback' => 'celestial_glory_quests_do_callback',
  	'page arguments' => array(2, 3),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
*/
  $items['celestial_glory/bishop/%'] = array(
    'title' => 'Celestial Glory Bishop',
    'page callback' => 'celestial_glory_bishop_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );

  $items['celestial_glory/bishop_ask_reset/%'] = array(
    'title' => 'Celestial Glory Bishop Ask Reset',
    'page callback' => 'celestial_glory_bishop_ask_reset_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );

  $items['celestial_glory/bishop_do_reset/%'] = array(
    'title' => 'Celestial Glory Bishop Do Reset',
    'page callback' => 'celestial_glory_bishop_do_reset_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );

  $items['celestial_glory/welcome/%'] = array(
    'title' => 'Celestial Glory Welcome',
    'page callback' => 'celestial_glory_welcome_callback',
  	'page arguments' => array(2),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
/*
  $items['celestial_glory/choose_clan/%/%'] = array(
    'title' => 'Celestial Glory Choose Clan',
    'page callback' => 'celestial_glory_choose_clan_callback',
  	'page arguments' => array(2, 3),
  	'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );

  $items['celestial_glory/help/%'] = array(
    'title' => 'Celestial Glory Help',
  	'page callback' => 'celestial_glory_help_callback',
  	'page arguments' => array(2),
    'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
  
  $items['celestial_glory/elections/%'] = array(
    'title' => 'Celestial Glory Elections List',
  	'page callback' => 'celestial_glory_elections_list_callback',
  	'page arguments' => array(2),
    'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
  
  $items['celestial_glory/elections_challenge/%/%'] = array(
    'title' => 'Celestial Glory Elections List',
  	'page callback' => 'celestial_glory_elections_challenge_callback',
  	'page arguments' => array(2, 3),
    'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );

  $items['celestial_glory/choose_name/%'] = array(
    'title' => 'Celestial Glory Choose Name',
  	'page callback' => 'celestial_glory_choose_name_callback',
  	'page arguments' => array(2),
    'access arguments' => array('access celestial_glory content'),
    'type' => MENU_CALLBACK,
  );
*/
  return $items;

}


function celestial_glory_homepage_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_homepage', $phone_id);

}


function celestial_glory_userprofile_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_userprofile', $phone_id);

}


function celestial_glory_quests_list_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_quests_list', $phone_id);

}


function celestial_glory_quests_do_callback($phone_id, $quest_id) {

  if (empty($phone_id) || !is_numeric($quest_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_quests_do', $phone_id, $quest_id);

}


function celestial_glory_bishop_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_bishop', $phone_id);

}


function celestial_glory_bishop_ask_reset_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_bishop_ask_reset', $phone_id);

}


function celestial_glory_bishop_do_reset_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_bishop_do_reset', $phone_id);

}


function celestial_glory_welcome_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_welcome', $phone_id);

}


function celestial_glory_choose_clan_callback($phone_id, $clan_id) {

  if (empty($phone_id) || !is_numeric($clan_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_choose_clan', $phone_id, $clan_id);

}


function celestial_glory_help_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

	return theme('celestial_glory_help', $phone_id);

}


function celestial_glory_elections_list_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

	return theme('celestial_glory_elections_list', $phone_id);

}


function celestial_glory_elections_challenge_callback($phone_id, $incumbent_id) {

  if (empty($phone_id) || !is_numeric($incumbent_id)) {
    return drupal_access_denied();
  }

	return theme('celestial_glory_elections_challenge', $phone_id, $incumbent_id);

}


function celestial_glory_choose_name_callback($phone_id) {

  if (empty($phone_id)) {
    return drupal_access_denied();
  }

  return theme('celestial_glory_choose_name', $phone_id);

}


function celestial_glory_theme() {
// theme "A" uses template "B" with args "C"

  return array(

    'celestial_glory_homepage' => array(
      'template' => 'celestial_glory_homepage',
      'arguments' => array(
	      'phone_id' => null
      )
    ),

    'celestial_glory_userprofile' => array(
      'template' => 'celestial_glory_userprofile',
      'arguments' => array(
	      'phone_id' => null
      )
    ),

    'celestial_glory_quests_list' => array(
      'template' => 'celestial_glory_quests_list',
      'arguments' => array(
	      'phone_id' => null
      )
    ),

    'celestial_glory_quests_do' => array(
      'template' => 'celestial_glory_quests_do',
      'arguments' => array(
	      'phone_id' => null,
    		'quest_id' => null,
      )
    ),

    'celestial_glory_bishop' => array(
      'template' => 'celestial_glory_bishop',
      'arguments' => array(
	      'phone_id' => null
      )
    ),

    'celestial_glory_bishop_ask_reset' => array(
      'template' => 'celestial_glory_bishop_ask_reset',
      'arguments' => array(
	      'phone_id' => null
      )
    ),

    'celestial_glory_bishop_do_reset' => array(
      'template' => 'celestial_glory_bishop_do_reset',
      'arguments' => array(
	      'phone_id' => null
      )
    ),

    'celestial_glory_welcome' => array(
      'template' => 'celestial_glory_welcome',
      'arguments' => array(
	      'phone_id' => null
      )
    ),
    
    'celestial_glory_choose_clan' => array(
      'template' => 'celestial_glory_choose_clan',
      'arguments' => array(
	      'phone_id' => null,
    		'clan_id' => null,
      )
    ),

    'celestial_glory_help' => array(
      'template' => 'celestial_glory_help',
      'arguments' => array(
    		'phone_id' => null,
      )
    ),
    
    'celestial_glory_elections_list' => array(
      'template' => 'celestial_glory_elections_list',
      'arguments' => array(
    		'phone_id' => null,
      )
    ),

    'celestial_glory_elections_challenge' => array(
      'template' => 'celestial_glory_elections_challenge',
      'arguments' => array(
    		'phone_id' => null,
    		'incumbent_id' => null,
      )
    ),

    'celestial_glory_choose_name' => array(
      'template' => 'celestial_glory_choose_name',
      'arguments' => array(
    		'phone_id' => null,
      )
    ),
    
  );

} // celestial_glory_theme()


function celestial_glory_init() {

	global $custom_theme;
	
	if (arg(0) == 'celestial_glory') {
		
		$custom_theme = 'cdc_games';
    drupal_add_css(drupal_get_path('module', 'celestial_glory') .
      '/celestial_glory.css');
  
	}
	
}


function _celestial_glory_fetch_user() {

	global $game, $phone_id, $extra_messages, $next_level;
	
	$changes_made = FALSE;
	
	$game = check_plain(filter_xss(arg(0)));
  $phone_id = check_plain(filter_xss(arg(2)));
	db_set_active('game_' . $game);

  $sql = 'select * from users where phone_id = "%s";';
  $result = db_query($sql, $phone_id);
  $game_user = db_fetch_object($result);
firep($game_user);

  if (empty($game_user->id)) drupal_goto($game . '/welcome/' . $phone_id);
// start welcome wizard if user not in db

	$energy_next_gain = strtotime($game_user->energy_next_gain);
	$secs_until = $energy_next_gain - time();

  $sql = 'select experience from levels where level = %d;';
  $result = db_query($sql, $game_user->level + 1);
  $level = db_fetch_object($result);
  $next_level = $level->experience;
  if ($next_level == 0) $next_level = 99999999;
  
  if ($game_user->experience >= $next_level) { // leveled up!
  	
  	$changes_made = $leveled_up = TRUE;
  	
  	if ($game_user->level >= 5)
  	  $game_user->energy_max += 10; // FIXME: give points to spend
    
  	  $game_user->energy = $game_user->energy_max;
    $game_user->level++;
    
    // leveled up?  read levels again!
    $sql = 'select experience from levels where level = %d;';
  	$result = db_query($sql, $game_user->level + 1);
  	$level = db_fetch_object($result);
  	$next_level = $level->experience;
  	if ($next_level == 0) $next_level = 99999999;
  	
    $extra_messages .= '<div class="level-up">
      <div class="level-up-header">Congratulations!</div>
      <div class="level-up-text">You have reached level ' . 
      $game_user->level . '!</div></div>';
 
  }
  
	while (($game_user->energy < $game_user->energy_max) &&
	  ($secs_until <= 0)) { // do we need energy?

	  $changes_made = TRUE;
	  $game_user->energy += 10; // add 10 energy
	  $energy_next_gain += 60;//300; // next add in 5 mins
	  $secs_until += 60;//300; // ditto
	  	
//	  firep('adding 10 to energy since we\'re due - energy now at ' . 
//	    $game_user->energy);
//	  firep('secs_until now at ' . $secs_until);
//	  firep('energy_next_gain now at ' . date('Y-m-d H:i:s',
//	    $energy_next_gain));
	}
	
	if ($game_user->energy > $game_user->energy_max) {
		$changes_made = TRUE; // just in case
	  $game_user->energy = $game_user->energy_max; // can't go beyond max
	}
	
	if ($changes_made) { // save changes, if needed
		
		$game_user->energy_next_gain = date('Y-m-d H:i:s', $energy_next_gain);
		$sql = 'update users set energy_next_gain = "%s",
		  energy = %d, energy_max = %d, level = %d where id = %d;';
  		$result = db_query($sql, $game_user->energy_next_gain,
  		  $game_user->energy, $game_user->energy_max, $game_user->level,
  		  $game_user->id);
//firep('Updating energy, energy_next_gain');

	}

	if ($leveled_up and ($game_user->level == 6))
		drupal_goto($game . '/choose_clan/' . $phone_id . '/0');
		
	return $game_user;
	 
}


function _celestial_glory_header($game_user) {

	global $game, $phone_id, $extra_messages, $next_level;
		
  $energy_text = '';
  
	if ($game_user->energy != $game_user->energy_max) {

		$secs_until = strtotime($game_user->energy_next_gain) - time();
//firep('secs_until now at ' . $secs_until);
		
		$minutes = (string) (int) ($secs_until / 60);
		$seconds = sprintf('%02d', (int) ($secs_until % 60));
		
		$energy_text = ' in ' . $minutes . ':' . $seconds;
		  
	}
	  
	echo <<< EOF
<div class="header">
<div class="money">$game_user->values: <strong>$game_user->money</strong></div>
<div class="experience">Spirituality: <strong>$game_user->experience</strong> /
  $next_level</div>
<div class="energy">Energy: <div id="energy-id">$game_user->energy</div> /
  $game_user->energy_max <div id="energy-time">$energy_text</div></div>
<div class="level">Level: <strong>$game_user->level</strong></div>
</div>
$extra_messages
<script type="text/javascript">

  var minutes = $minutes;
  var seconds = $seconds;
  var energy = $game_user->energy;
  var energy_max = $game_user->energy_max;
  var energy_to_add = 10;
  var energy_interval = 60;
  
  function display_energy() {
  
    document.getElementById('energy-id').innerHTML = energy;
    
    if (energy < energy_max) {
      
      document.getElementById('energy-time').innerHTML = ' in ' + minutes + ':' +
        (seconds < 10 ? '0' + seconds : seconds);

    } else {
    
      document.getElementById('energy-time').innerHTML = '';
    
    }
      
  }
  
  function add_energy() {
  
  	if ((seconds == 0) && (minutes > 0)) {
    
			seconds = 60;
			minutes -= 1;
					
    }
    
    seconds--;
    
    if ((seconds == 0) && (minutes == 0)) {
    
			energy += energy_to_add;
			seconds = energy_interval % 60;
			minutes = Math.floor(energy_interval / 60);
					
    }
    
    if (energy >= energy_max) {
    
      energy = energy_max;
      clearInterval(energy_interval_timer);
      
    }
    
    display_energy();

  }
  
  var energy_interval_timer = setInterval('add_energy()', 1000);

</script>
EOF;

}

                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                

                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                


                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                

                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                


                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                

                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
                                                                                
